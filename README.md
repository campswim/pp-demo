# P&P Demo

A unique system that allows users to log into accounts containing sensitive information by saying or entering a predetermined PIN via telephone.

## Stack

1. Frontend

    - **Next.js**: a React framework for building web applications with features like server-side rendering (SSR), static site generation (SSG), API routes, routing, and built-in optimizations, it bridges the front- and backends,  serving as the core application layer in full-stack apps.

    - **React**: a JavaScript library for building user interfaces, primarily for web applications, it allows developers to create reusable UI components and efficiently update the interface when data changes using a virtual DOM.

    - **TailwindCSS**: a utility-first CSS library that enables styling by applying pre-defined classes directly to HTML elements, allowing for rapid UI development; the library is fully customizable, promotes design consistency, and integrates well with component-based libraries like React.
  
    - **ShadCN**: a collection of accessible, headless UI components for React, built with Radix and styled using Tailwind CSS, designed to be copied into projects for full customization and control.

2. Backend

    - **Next.js** (API Layer): with backend capabilities, such as API routes and server actions, it enables the creation of custom endpoints, session management, authentication flows, and data processing logic without a separate backend server.

    - **Supabase**: an open-source backend-as-a-service (BaaS) platform that provides an easy way to set up a fully functional backend for web and mobile applications, including an auto-generated REST API based on the structure of the database; it also manages the PostgreSQL database.

3. Database

    - **Postgre**: an open-source SQL database.

    - **Prisma**: an open-source ORM (Object-Relational Mapping) tool that allows for the querying and manipulation of databases using JavaScript or TypeScript, without needing to write raw SQL queries, by generating a strongly typed API based on the database's schema.
  
4. Language

    - **TypeScript**: a statically typed superset of JavaScript that adds compile-time type checking and modern features, improving code safety, editor support, and maintainability across both front- and backend logic.

    - **CSS**: a stylesheet language used to define the visual presentation of HTML elements, including layout, color, spacing, and typography; in this stack, it is mostly generated through utility classes provided by Tailwind CSS, though sometimes written directly.

    - **JSX**: a syntax extension for JavaScript used in React to describe UI structure, compiling down to JavaScript and ultimately rendering HTML.

    - **SQL**: the language of the underlying Postgres database, sometimes written directly and often generated by Prisma.

    - **JSON**: a lightweight data-interchange format based on JavaScript syntax, used for transmitting structured data between systems, such as in API responses, configuration files, and client-server communication.

5. Utilities

    - **Zod**: a schema-validation library designed for TypeScript, helping developers define and validate data structures, ensuring type safety at both compile time and runtime.

    - **ngrok**: a tool that creates a secure, public URL for a local server, acting as a tunnel from the internet to a local machine, a useful setup in development for connecting to third-party services, like Twilio, or providing access to a local app on the internet.

## Instructions

### Development Environment

- Run `npm run dev` in the terminal to spin up a development version of the frontend on <http://localhost:3000>.
- Run `ngrok http 3000`--`npx ngrok http 3000`, if it's not installed globally--in the terminal to expose the backend via an ngrok tunnel to the TWilio API (the port should match the frontend's); then, copy the URL from the terminal's output and use it as the value of the BASE_URL in the .env file.

### Production Environment

### Supabase

[Docs](https://supabase.com/)

### [Prisma](https://www.prisma.io/docs)

[Prisma CRUD Documentation](https://www.prisma.io/docs/concepts/components/prisma-client/crud)

- Install prisma vs-code extension.
- Install Prisma: `npm install prisma --save-dev`
- Install the Prisma client: `npm install @prisma/client`
- Initialize Prisma: `npx prisma init`
- Push changes to the DB (one or the other):
  - Merge into the DB: `npx prisma migrate dev --name init`
  - Overwrite the DB: `npx prisma db push`
- To view the DB in a UI: `npx prisma studio`
- To avoid re-connecting to the DB when there's already a connection ([Prisma Instance](https://www.prisma.io/docs/guides/other/troubleshooting-orm/help-articles/nextjs-prisma-client-dev-practices#solution)):
  - Create utils/db.ts
  - Add the following code:

  ```ts
  import { PrismaClient } from '@prisma/client';

  const prismaClientSingleton = () => {
    return new PrismaClient();
  };

  type PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>;

  const globalForPrisma = globalThis as unknown as {
    prisma: PrismaClientSingleton | undefined;
  };

  const prisma = globalForPrisma.prisma ?? prismaClientSingleton();

  export default prisma;

  if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
  ```

### Connect Supabase with Prisma

- Log into your Supabase account.
- Click the Connect button in the navbar.
- Choose ORMs from the "Connect to your project" modal's navbar.
- Select Prisma and copy and paste the ENV values into your .env and the schema values into your prisma/schema.prisma file.

## User Stories

As a user, I’d like to:

- [x] create a new account, entering my login credentials for both password and phone-and-pin authentication;
- [ ] have access to a method of safely resetting my password and/or PIN and/or safe words, in the event that I forget them or otherwise feel they are in need of change, e.g., have been compromised;
- [x] speak my safe word(s) via phone before I enter my PIN;
- [x] be presented with clear instructions via phone about what to do;
- [x] hear a polite voice via phone with correct grammar and a proper salutation and valediction;
- [x] log into my account with a password via the website and with a safe word and PIN via phone.
- [x] see a spinner on the login page while the phone call is in progress;
- [x] see a message on the webpage communicating the result of the authentication process, whether successful or otherwise;
- [x] have at least two chances to enter my password or my PIN in the event that my first attempt was unsuccessful;
- [x] be logged into my account after successfully authenticating;
- [ ] be presented with a method for contacting customer support in the event that my attempts to authenticate fail;
- [ ] be presented with:
  - [x] clear error messages in the event of a failure, whether on my part or that of the system;
  - [ ] and a method for resolving the errors.

As an administrator, I’d like to:

- [ ] create client accounts, e.g., a bank, under which to save UI settings and user account information;
- [ ] adjust the basic formatting of the demo’s UI to match the potential customer’s website, including:
  - [ ] the background color;
  - [ ] the banner color;
  - [ ] the company logo;
  - [ ] the navbar color, font style, and font size.
- [ ] create user accounts;
- [ ] edit users’ account details;
- [ ] delete user accounts;
- [ ] have access to the code base;
- [ ] have clear and concise documentation related to:
  - [ ] the deployment of the demo in a development environment;
  - [ ] the deployment of the demo in a production environment;
  - [ ] the use of the settings page to alter the UI;
  - [ ] all third-party services, their purposes, their costs, and the credentials required to access them.

## Auth Flow

| Event | Who runs it | Actions |
|:-----------|:--------------|:-----------|
| Login | Server Action | Set auth & refresh cookies + set loggedIn = true in DB |
| Request with valid token| Middleware | Allow request |
| Request with expired access token | Middleware | Refresh auth cookies |
| Request with expired refresh token | Middleware | Clear auth cookies; set expired-user-id cookie (frontend) |
| Manual Logout | Server Action | Clear auth cookies + set loggedIn = false in DB. |
| Auto-logout (tokens expired) | Logged-in Context + Server Action | Detect expired-user-id cookie and call logout, which clears the cookie and redirects to /login |
